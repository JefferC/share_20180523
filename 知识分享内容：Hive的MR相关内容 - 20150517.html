<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="423"/>

<div>
<span><div><div><span style="font-weight: bold;">内容：</span></div><ol><li><div><span style="font-weight: bold;">Hive在什么情况下会起MapReduce</span></div></li><li><div><span style="font-weight: bold;">哪些场景只有Map没有Reduce</span></div></li><li><div><span style="font-weight: bold;">执行计划详解及优化的一些方法</span></div></li></ol><div><br/></div><div><span style="font-weight: bold;">一、Hive在什么情况下会起MapReduce</span></div><div><br/></div><div>早期的Hive，几乎任何SQL都是通过MapReduce完成的。</div><div>0.10.0版本后，简单的列查询。可以选择通过fetch task来完成。需要设置参数：</div><div>set hive.fetch.task.conversion=more;</div><div>Select Col_1,Col_2 from Table_1 Limit 10;</div><div>最简单的Select * from Table_1也不会起MR任务。</div><div>以下有一篇总结：</div><div><a href="http://www.cnblogs.com/staryea/p/8570538.html">http://www.cnblogs.com/staryea/p/8570538.html</a></div><div>从筛选条件看大致上：等值比较、模糊查询（通配符%在任意位置）、不等比较、大小于、Null判断、正则模糊查询（RLike）</div><div>这是在SELECT部分为*或者固定字段并且单表查询的情况下。</div><div>一旦关联或者出现了聚合函数以及出现排序。则必然会起MR。</div><div><br/></div><div><span style="font-weight: bold;">二、哪些场景只有Map没有Reduce</span></div><div><br/></div><div>Hive获得SQL后，解析为抽象语法树。</div><div>此时会有限判断是否需要起MR。随后判断是否需要Reduce Job。</div><div>随后会判断Reduce作业的数量。</div><div>最简单的SQL类似：Select * From Table Where dt = '20180101';</div><div>包括各种普通的筛选条件（大小于，模糊查询，正则模糊查询）</div><div>并且没有聚合函数及排序。</div><div>另外，还有Map Side Join的关联操作。job只有map阶段而没有Reduce阶段。（同样不包含聚合函数排序等其他因素）</div><div>这时候Hive会将reduce task的数量设置为0。</div><div>如果在控制台执行会看到Hive打印一行字：</div><div>Number of reduce tasks is set to 0 since there's no reduce operator</div><div>这样就起了一个Map Only Job。这样的作业在执行过程中跳过了Shuffle和Reduce阶段。因此会比普通的作业使用到更少的集群资源。而且还更快。</div><div><br/></div><div><span style="font-weight: bold;">三、执行计划详解</span></div><div><br/></div><div>查看语句的执行计划在语句前加explain。</div><div><br/></div><div>标准的语法：</div><div>EXPLAIN [EXTENDED|DEPENDENCY|AUTHORIZATION] query</div><div><br/></div><div><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Explain">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Explain</a></div><div><br/></div><div>执行explain后。控制台会打印出三块内容</div><div><br/></div><div>第一块是SQL解析后得到的抽象语法树</div><div>第二块是步骤依赖</div><div>第三块是步骤计划</div><div><br/></div><div>抽象语法树意义不大。单纯的解析并结构化了SQL而已。</div><div>也有大神详解：<a href="https://blog.csdn.net/an342647823/article/details/36385479">https://blog.csdn.net/an342647823/article/details/36385479</a></div><div><br/></div><div>步骤依赖：</div><div>例：</div><div>STAGE DEPENDENCIES:</div><div><span style="font-style: italic;">Stage-1 is a root stage</span></div><div><span style="font-style: italic;">Stage-2 depends on stages: Stage-1</span></div><div><span style="font-style: italic;">Stage-0 depends on stages: Stage-2</span></div><div><br/></div><div>步骤1是初始步骤。</div><div>步骤2依赖步骤1。</div><div>步骤0依赖步骤2。</div><div><br/></div><div>以上例子由于存在依赖无法并行执行。</div><div>也有可以并行执行的例子。</div><div><span style="font-style: italic;">Stage-1 is a root stage</span></div><div><span style="font-style: italic;">Stage-0 is a root stage</span></div><div><br/></div><div>这样的话步骤0和步骤1相互之间没有依赖，可以并行。</div><div><br/></div><div>关于并行优化：</div><div>set hive.exec.parallel=true;</div><div>set hive.exec.parallel.thread.number=10;</div><div>上面第一个参数开启任务并行</div><div>第二个参数设置单sql并行的MR job个数。</div><div><br/></div><div>步骤计划：</div><div>也就是操作树。</div><div>这里分不同的stage步骤。每个stage就是一个MapReduce。</div><div>每个Stage包含Map操作树和Reduce操作树。</div><div>以一个insert语句为例</div><div>FROM src INSERT OVERWRITE TABLE dest_g1 SELECT src.key, sum(substr(src.value,4)) GROUP BY src.key;</div><div><br/></div><div>该SQL包含三个步骤。依赖分别是：</div><div><span style="font-style: italic;">Stage-1 is a root stage</span></div><div><span style="font-style: italic;">Stage-2 depends on stages: Stage-1</span></div><div><span style="font-style: italic;">Stage-0 depends on stages: Stage-2</span></div><div><br/></div><div>执行计划：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>STAGE PLANS:</div><div> Stage: Stage-1</div><div>   Map Reduce</div><div>     Alias -&gt; Map Operator Tree:</div><div>       src</div><div>           Reduce Output Operator</div><div>             key expressions:</div><div>                   expr: key</div><div>                   type: string</div><div>             sort order: +</div><div>             Map-reduce partition columns:</div><div>                   expr: rand()</div><div>                   type: double</div><div>             tag: -1</div><div>             value expressions:</div><div>                   expr: substr(value, 4)</div><div>                   type: string</div><div>     Reduce Operator Tree:</div><div>       Group By Operator</div><div>         aggregations:</div><div>               expr: sum(UDFToDouble(VALUE.0))</div><div>         keys:</div><div>               expr: KEY.0</div><div>               type: string</div><div>         mode: partial1</div><div>         File Output Operator</div><div>           compressed: false</div><div>           table:</div><div>               input format: org.apache.hadoop.mapred.SequenceFileInputFormat</div><div>               output format: org.apache.hadoop.mapred.SequenceFileOutputFormat</div><div>               name: binary_table</div><div> Stage: Stage-2</div><div>   Map Reduce</div><div>     Alias -&gt; Map Operator Tree:</div><div>       /tmp/hive-zshao/67494501/106593589.10001</div><div>         Reduce Output Operator</div><div>           key expressions:</div><div>                 expr: 0</div><div>                 type: string</div><div>           sort order: +</div><div>           Map-reduce partition columns:</div><div>                 expr: 0</div><div>                 type: string</div><div>           tag: -1</div><div>           value expressions:</div><div>                 expr: 1</div><div>                 type: double</div><div>     Reduce Operator Tree:</div><div>       Group By Operator</div><div>         aggregations:</div><div>               expr: sum(VALUE.0)</div><div>         keys:</div><div>               expr: KEY.0</div><div>               type: string</div><div>         mode: final</div><div>         Select Operator</div><div>           expressions:</div><div>                 expr: 0</div><div>                 type: string</div><div>                 expr: 1</div><div>                 type: double</div><div>           Select Operator</div><div>             expressions:</div><div>                   expr: UDFToInteger(0)</div><div>                   type: int</div><div>                   expr: 1</div><div>                   type: double</div><div>             File Output Operator</div><div>               compressed: false</div><div>               table:</div><div>                   input format: org.apache.hadoop.mapred.TextInputFormat</div><div>                   output format: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat</div><div>                   serde: org.apache.hadoop.hive.serde2.dynamic_type.DynamicSerDe</div><div>                   name: dest_g1</div><div> Stage: Stage-0</div><div>   Move Operator</div><div>     tables:</div><div>           replace: true</div><div>           table:</div><div>               input format: org.apache.hadoop.mapred.TextInputFormat</div><div>               output format: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat</div><div>               serde: org.apache.hadoop.hive.serde2.dynamic_type.DynamicSerDe</div><div>               name: dest_g1</div></div><div><br/></div><div>先看Stage-1</div><div>第一行：Stage： Stage-1   // 相当于一个tag。表示这段是Stage-1</div><div>第二行：Map Reduce   // 表示需要执行MapReduce</div><div>第三行：Alias -&gt; Map Operator Tree:  // 表示Map操作树</div><div>第四行：src    // 这个是操作的表</div><div><br/></div><div>map操作：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Reduce Output Operator   // Map段的本地简化操作，最终将结果给到对应的Reduce操作中。所有这种xxxx Operator都是操作符</div><div> key expressions:       // 键表达式 这里先的key表达是src表中的字段，type后面是它的类型，这里是string</div><div>       expr: key</div><div>       type: string</div><div> sort order: +          // 排序，这里只有一个key。因此只有一个符号。如有多个key则有多个。+是升序，-是降序</div><div> Map-reduce partition columns:  // hadoop partition</div><div>       expr: rand()</div><div>       type: double</div><div> tag: -1</div><div> value expressions:     // 值的表达式</div><div>       expr: substr(value, 4)   // 这里是于SQL中一样的表达式，类型是string</div><div>       type: string</div></div><div><br/></div><div>下面是Reduce的操作树：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Group By Operator                      // 分组操作</div><div> aggregations:                        // 聚合操作，expr是表达式。这段SQL是sum操作。后面UDFToDouble将值转成了double形（map传过来的是string）</div><div>       expr: sum(UDFToDouble(VALUE.0))</div><div> keys:                                // 键，表达式是KEY.0 这里的0和VALUE中的0都是值键或值的组中的元素，即列名。type为string</div><div>       expr: KEY.0</div><div>       type: string</div><div> mode: partial1                       // 模式，这个partial1是指:从原始数据到部分数据聚合。是MapReduce的Map阶段</div><div> File Output Operator                 // 文件输出操作，compressed false不压缩。这里是输出到文件了</div><div>   compressed: false                  // 后面分别指定了结果输出到表。并且指定了输入文件类型及输出文件类型。</div><div>   table:</div><div>       input format: org.apache.hadoop.mapred.SequenceFileInputFormat</div><div>       output format: org.apache.hadoop.mapred.SequenceFileOutputFormat</div><div>       name: binary_table</div></div><div><br/></div><div>可以看到，Stage-1将数据全部拿到后生成键值对给到reduce。reduce进行了分组和聚合操作生成新的键值对并输出到二进制文本。</div><div><br/></div><div>接下来看依赖于Stage-1的Stage-2。</div><div>前面都是一样的。</div><div>以下是Map操作树：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Alias -&gt; Map Operator Tree:</div><div>/tmp/hive-zshao/67494501/106593589.10001  // 该目录应该是Stage-1输出的临时文本文件。以该文件作为Stage-2 Map的输入</div><div> Reduce Output Operator                  // 输出到本地Reduce操作。这里没有做什么操作。就是拿了然后输出。</div><div>   key expressions:</div><div>         expr: 0</div><div>         type: string</div><div>   sort order: +</div><div>   Map-reduce partition columns:</div><div>         expr: 0</div><div>         type: string</div><div>   tag: -1</div><div>   value expressions:</div><div>         expr: 1</div><div>         type: double</div></div><div><br/></div><div>以下是Reduce操作树</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Group By Operator        // 分组，关于键进一步聚合，做sum。（Stage-1的模式是partial1,是部分数据的聚合）模式为final：完整数据聚合</div><div> aggregations:</div><div>       expr: sum(VALUE.0)</div><div> keys:</div><div>       expr: KEY.0</div><div>       type: string</div><div> mode: final</div><div> Select Operator        // 查询操作，这里的0，1是列名。本例中0是key，1是聚合的值</div><div>   expressions:</div><div>         expr: 0</div><div>         type: string</div><div>         expr: 1</div><div>         type: double</div><div>   Select Operator      // 查询操作，对列0做了UDFToInteger操作。输出成了int</div><div>     expressions:</div><div>           expr: UDFToInteger(0)</div><div>           type: int</div><div>           expr: 1</div><div>           type: double</div><div>     File Output Operator  // 输出为文件。不压缩。这里多了指定了个serde序列器。</div><div>       compressed: false</div><div>       table:</div><div>           input format: org.apache.hadoop.mapred.TextInputFormat</div><div>           output format: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat</div><div>           serde: org.apache.hadoop.hive.serde2.dynamic_type.DynamicSerDe</div><div>           name: dest_g1</div></div><div><br/></div><div>Stage-2对完整数据做了聚合。输出到txt文件</div><div><br/></div><div>最后是Stage-0</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Move Operator                // 非常好理解。移动操作。并将原来的文件替换了。</div><div> tables:</div><div>       replace: true</div><div>       table:</div><div>           input format: org.apache.hadoop.mapred.TextInputFormat</div><div>           output format: org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat</div><div>           serde: org.apache.hadoop.hive.serde2.dynamic_type.DynamicSerDe</div><div>           name: dest_g1</div></div><div><br/></div><div>Stage-0是一个非MapReduce操作。文件系统关联的步骤。将Stage-2的结果从临时目录移动到了dest_g1的目录下。并替换了原来该目录下文件。</div><div><br/></div><div>本例只是个简单的单表聚合插入的sql。并没有涵盖特别多的Hive操作内容。</div><div>Hive的操作符一般包含这些：TableScanOperator，SelectOperator，FilterOperator，JoinOperator，GroupByOperator，ReduceSinkOperator</div><div>看名字就知道是什么操作了。需要说明一下的事最后一个Reduce Sink Operator。</div><div>ReduceSinkOperator将Map端的字段组合序列化为Reduce Key/value, Partition Key，只可能出现在Map阶段，同时也标志着Hive生成的MapReduce程序中Map阶段的结束。</div><div>Reduce Sink Operator通常在SQL包含排序，关联等操作的时候会有。</div><div><br/></div><div>以下举几个以上例子中没有出现的操作的例子：</div><div>TableScanOperator：</div><div><span style="font-style: italic;">TableScan</span></div><div><span style="font-style: italic;">    alias: mytb</span></div><div><br/></div><div>FilterOperator：</div><div><span style="font-style: italic;">Filter Operator</span></div><div><span style="font-style: italic;">    predicate: (((deal_id = '') or (deal_id = '-')) or deal_id is null) (type: boolean)</span></div><div><br/></div><div><br/></div><div>每个Operator都是个Java类。包含了属性和各种方法。对于深度了解Hive有兴趣的同学。可以看源码。</div><div><br/></div><div>另外，还有一些与通常情况不太一样的执行计划。例如一个被判断为本地模式可以执行的SQL。</div><div>如果被判断为本地模式执行的SQL。也没有去看执行计划的必要了。它必然快速。且数据量不大。优化的需求相对来说不大。</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">本地MapReduce</span></div><div>也就是Hive优化中大名鼎鼎的本地模式。仅在本地执行MR。效率非常高。</div><div>SET hive.exec.mode.local.auto = true</div><div>开启自动本地模式。（Cloudera的CDH平台该参数是默认开启的。）</div><div>对于满足一下三个条件的作业，Hive将会启动本地模式。</div><div>条件1：输入Map的数据小于参数hive.exec.mode.local.auto.inputbytes.max</div><div>条件2：Map的作业数量小于参数hive.exec.mode.local.auto.tasks.max</div><div>条件3：Reduce作业数小于等于1（可以设置：set mapred.reduce.tasks = n(n为自然数)，或者设置每个Reduce作业的数据量：hive.exec.reducers.bytes.per.reducer）</div><div><br/></div><div>决定map作业数量的条件有两个：</div><div>1、输入的文件个数</div><div>2、大文件的大小</div><div>简单来说就是小于hdfs一个block的文件有一个就起一个map。反过来大于这个大小的文件会切成符合条件的多个并且起同等数量的map作业。</div><div>不过这不是绝对。如果设置了合并小文件。map作业数可能减少。</div><div>关于该设置，需要设置的参数有：hive.input.format = <a href="http://org.apache.hadoop.hive.ql.io.combinehiveinputformat/">org.apache.hadoop.hive.ql.io.CombineHiveInputFormat</a>（这个参数使Hive在map前执行了合并小文件操作）</div><div>并且设置 mapred.max.split.size（hive每个map的最大文件的大小）</div></div><div>mapred.min.split.size.per.node（每个节点分割文件的最小大小）</div><div>mapred.min.split.size.per.rack（这个是指每个交换机上分割文件的最小大小）</div><div>该设置在输入文件中小文件很多的情况下可以增加执行的效率。</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">谈一下从执行计划可以得出的优化方案</span></div><div><br/></div><div>前面已经提到一个方式。如果job之间相互不存在依赖。可以设置并行。</div><div><br/></div><div>目前，如果Hive版本足够高的话。可以在执行计划中看到每一步的数据量。</div><div>在输入数据量不大的情况下。可以考虑修改参数，令hive本地模式执行sql。</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Map Reduce Local Work</div><div> Alias -&gt; Map Local Tables:</div><div>   b</div><div>     Fetch Operator</div><div>       limit: -1</div><div> Alias -&gt; Map Local Operator Tree:</div><div>   b</div><div>     TableScan</div><div>       alias: b</div><div>       Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>       Filter Operator</div><div>         predicate: (id = 1) (type: boolean)</div><div>         Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: NONE</div><div>         HashTable Sink Operator</div><div>           keys:</div><div>             0 id (type: int)</div><div>             1 id (type: int)</div><div><br/></div></div><div><br/></div><div>多表关联尽量用同一个key来做关联条件。这一点在执行计划上体现得非常突出。</div><div>举个例子：</div><div>SQL1：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>explain select * from thirdtb c join firsttb a on a.id = c.tid left join secondtb b on b.id = c.tid;</div><div>STAGE DEPENDENCIES:</div><div> Stage-5 is a root stage</div><div> Stage-4 depends on stages: Stage-5</div><div> Stage-0 depends on stages: Stage-4</div><div><br/></div><div>STAGE PLANS:</div><div> Stage: Stage-5</div><div>   Map Reduce Local Work</div><div>     Alias -&gt; Map Local Tables:</div><div>       a</div><div>         Fetch Operator</div><div>           limit: -1</div><div>       b</div><div>         Fetch Operator</div><div>           limit: -1</div><div>     Alias -&gt; Map Local Operator Tree:</div><div>       a</div><div>         TableScan</div><div>           alias: a</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           HashTable Sink Operator</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div>       b</div><div>         TableScan</div><div>           alias: b</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           HashTable Sink Operator</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div><br/></div><div> Stage: Stage-4</div><div>   Map Reduce</div><div>     Map Operator Tree:</div><div>         TableScan</div><div>           alias: c</div><div>           Statistics: Num rows: 2 Data size: 10 Basic stats: COMPLETE Column stats: NONE</div><div>           Map Join Operator</div><div>             condition map:</div><div>                  Inner Join 0 to 1</div><div>                  Left Outer Join0 to 2</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div>             outputColumnNames: _col0, _col1, _col2, _col6, _col10</div><div>             Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>             Select Operator</div><div>               expressions: _col0 (type: int), _col1 (type: int), _col2 (type: int), _col6 (type: int), _col10 (type: int)</div><div>               outputColumnNames: _col0, _col1, _col2, _col3, _col4</div><div>               Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>               File Output Operator</div><div>                 compressed: false</div><div>                 Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>                 table:</div><div>                     input format: org.apache.hadoop.mapred.TextInputFormat</div><div>                     output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</div><div>                     serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</div><div>     Local Work:</div><div>       Map Reduce Local Work</div><div><br/></div><div> Stage: Stage-0</div><div>   Fetch Operator</div><div>     limit: -1</div><div>     Processor Tree:</div><div>       ListSink</div><div><br/></div></div><div><br/></div><div>SQL2：</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>explain select * from thirdtb c join firsttb a on a.id = c.tid left join secondtb b on b.id = c.oid;</div><div>STAGE DEPENDENCIES:</div><div> Stage-7 is a root stage</div><div> Stage-5 depends on stages: Stage-7</div><div> Stage-0 depends on stages: Stage-5</div><div><br/></div><div>STAGE PLANS:</div><div> Stage: Stage-7</div><div>   Map Reduce Local Work</div><div>     Alias -&gt; Map Local Tables:</div><div>       a</div><div>         Fetch Operator</div><div>           limit: -1</div><div>       b</div><div>         Fetch Operator</div><div>           limit: -1</div><div>     Alias -&gt; Map Local Operator Tree:</div><div>       a</div><div>         TableScan</div><div>           alias: a</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           Filter Operator</div><div>             predicate: id is not null (type: boolean)</div><div>             Statistics: Num rows: 1 Data size: 1 Basic stats: COMPLETE Column stats: NONE</div><div>             HashTable Sink Operator</div><div>               keys:</div><div>                 0 tid (type: int)</div><div>                 1 id (type: int)</div><div>       b</div><div>         TableScan</div><div>           alias: b</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           HashTable Sink Operator</div><div>             keys:</div><div>               0 _col1 (type: int)</div><div>               1 id (type: int)</div><div><br/></div><div> Stage: Stage-5</div><div>   Map Reduce</div><div>     Map Operator Tree:</div><div>         TableScan</div><div>           alias: c</div><div>           Statistics: Num rows: 2 Data size: 10 Basic stats: COMPLETE Column stats: NONE</div><div>           Filter Operator</div><div>             predicate: tid is not null (type: boolean)</div><div>             Statistics: Num rows: 1 Data size: 5 Basic stats: COMPLETE Column stats: NONE</div><div>             Map Join Operator</div><div>               condition map:</div><div>                    Inner Join 0 to 1</div><div>               keys:</div><div>                 0 tid (type: int)</div><div>                 1 id (type: int)</div><div>               outputColumnNames: _col0, _col1, _col2, _col6</div><div>               Statistics: Num rows: 1 Data size: 5 Basic stats: COMPLETE Column stats: NONE</div><div>               Map Join Operator</div><div>                 condition map:</div><div>                      Left Outer Join0 to 1</div><div>                 keys:</div><div>                   0 _col1 (type: int)</div><div>                   1 id (type: int)</div><div>                 outputColumnNames: _col0, _col1, _col2, _col6, _col10</div><div>                 Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>                 Select Operator</div><div>                   expressions: _col0 (type: int), _col1 (type: int), _col2 (type: int), _col6 (type: int), _col10 (type: int)</div><div>                   outputColumnNames: _col0, _col1, _col2, _col3, _col4</div><div>                   Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>                   File Output Operator</div><div>                     compressed: false</div><div>                     Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>                     table:</div><div>                         input format: org.apache.hadoop.mapred.TextInputFormat</div><div>                         output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</div><div>                         serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</div><div>     Local Work:</div><div>       Map Reduce Local Work</div><div><br/></div><div> Stage: Stage-0</div><div>   Fetch Operator</div><div>     limit: -1</div><div>     Processor Tree:</div><div>       ListSink</div><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">SQL3:</span></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>explain select * from thirdtb c join firsttb a on a.id = c.tid left join secondtb b on a.id = b.id;</div><div>STAGE DEPENDENCIES:</div><div> Stage-5 is a root stage</div><div> Stage-4 depends on stages: Stage-5</div><div> Stage-0 depends on stages: Stage-4</div><div><br/></div><div>STAGE PLANS:</div><div> Stage: Stage-5</div><div>   Map Reduce Local Work</div><div>     Alias -&gt; Map Local Tables:</div><div>       a</div><div>         Fetch Operator</div><div>           limit: -1</div><div>       b</div><div>         Fetch Operator</div><div>           limit: -1</div><div>     Alias -&gt; Map Local Operator Tree:</div><div>       a</div><div>         TableScan</div><div>           alias: a</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           HashTable Sink Operator</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div>       b</div><div>         TableScan</div><div>           alias: b</div><div>           Statistics: Num rows: 2 Data size: 2 Basic stats: COMPLETE Column stats: NONE</div><div>           HashTable Sink Operator</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div><br/></div><div> Stage: Stage-4</div><div>   Map Reduce</div><div>     Map Operator Tree:</div><div>         TableScan</div><div>           alias: c</div><div>           Statistics: Num rows: 2 Data size: 10 Basic stats: COMPLETE Column stats: NONE</div><div>           Map Join Operator</div><div>             condition map:</div><div>                  Inner Join 0 to 1</div><div>                  Left Outer Join1 to 2</div><div>             keys:</div><div>               0 tid (type: int)</div><div>               1 id (type: int)</div><div>               2 id (type: int)</div><div>             outputColumnNames: _col0, _col1, _col2, _col6, _col10</div><div>             Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>             Select Operator</div><div>               expressions: _col0 (type: int), _col1 (type: int), _col2 (type: int), _col6 (type: int), _col10 (type: int)</div><div>               outputColumnNames: _col0, _col1, _col2, _col3, _col4</div><div>               Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>               File Output Operator</div><div>                 compressed: false</div><div>                 Statistics: Num rows: 4 Data size: 22 Basic stats: COMPLETE Column stats: NONE</div><div>                 table:</div><div>                     input format: org.apache.hadoop.mapred.TextInputFormat</div><div>                     output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</div><div>                     serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</div><div>     Local Work:</div><div>       Map Reduce Local Work</div><div><br/></div><div> Stage: Stage-0</div><div>   Fetch Operator</div><div>     limit: -1</div><div>     Processor Tree:</div><div>       ListSink</div><div><br/></div></div><div><br/></div><div><br/></div><div><br/></div><div>比较明显。用相同key做关联的SQL1的操作符为10个，而非同一key的SQL2则需要13个操作符来完成关联。SQL3与SQL1一样.</div><div>在可选的情况下。尽量多表关联使用同一个key来关联是消耗集群资源最低，也是最为快速的执行的方案。</div><div><br/></div><div>接下来不再一一举例。仅提出一些优化的方案：</div><div>表关联的时候，小表在前。或指定大表。情况允许下，尽量使用map端join（可以使关联部分的MR任务转为Map Only Job）。</div><div><br/></div><div>复杂sql使得执行计划复杂化。建议做中间表。简化执行计划。</div><div><br/></div><div>此外，可能在执行计划上没有体现。但是实际数据的问题导致的性能低下</div><div><br/></div><div>具体的执行计划请大家自行尝试。</div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">EXPLAIN  AUTHORIZATION SQL</span></div><div><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>INPUTS:</div><div> default@srcpart</div><div> default@src</div><div> default@srcpart@ds=2008-04-08/hr=11</div><div> default@srcpart@ds=2008-04-08/hr=12</div><div> default@srcpart@ds=2008-04-09/hr=11</div><div> default@srcpart@ds=2008-04-09/hr=12</div><div>OUTPUTS:</div><div><a href="hdfs://localhost:9000/tmp/.../-mr-10000">hdfs://localhost:9000/tmp/.../-mr-10000</a></div><div>CURRENT_USER:</div><div> navis</div><div>OPERATION:</div><div> QUERY</div><div>AUTHORIZATION_FAILURES:</div><div> Permission denied: Principal [name=navis, type=USER] does not have following privileges for operation QUERY [[SELECT] on Object [type=TABLE_OR_VIEW, name=default.src], [SELECT] on Object [type=TABLE_OR_VIEW, name=default.srcpart]]</div></div><div><br/></div><div>可以看到打印了输入的表，分区。临时结果存放的目录。当前用户，操作方式。以及一个权限异常。</div><div><br/></div><div><span style="font-weight: bold;">EXPLAIN DEPENDENCY SQL</span></div><div><br/></div><div>The use of DEPENDENCY in the EXPLAIN statement produces extra information about the inputs in the plan. It shows various attributes for the inputs</div><div>该语句输出执行计划中会数据输入的信息。以及各种属性。</div><div>如下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>{&quot;input_partitions&quot;:[</div><div>{&quot;partitionName&quot;:&quot;default&lt;at:var at:name=&quot;srcpart&quot; /&gt;ds=2008-04-08/hr=11&quot;},</div><div>{&quot;partitionName&quot;:&quot;default&lt;at:var at:name=&quot;srcpart&quot; /&gt;ds=2008-04-08/hr=12&quot;},</div><div>{&quot;partitionName&quot;:&quot;default&lt;at:var at:name=&quot;srcpart&quot; /&gt;ds=2008-04-09/hr=11&quot;},</div><div>{&quot;partitionName&quot;:&quot;default&lt;at:var at:name=&quot;srcpart&quot; /&gt;ds=2008-04-09/hr=12&quot;}]</div><div>,&quot;input_tables&quot;:[</div><div>{&quot;tablename&quot;:&quot;default@srcpart&quot;</div><div>,&quot;tabletype&quot;:&quot;MANAGED_TABLE&quot;}]}</div></div><div><br/></div><div><br/></div><div><br/></div><div><a href="http://www.cnblogs.com/ITtangtang/p/7683028.html">http://www.cnblogs.com/ITtangtang/p/7683028.html</a></div><div><br/></div></span>
</div></body></html> 